{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"AWS Observability Accelerator for CDK","text":"<p>Welcome to the AWS Observability Accelerator for CDK!</p> <p>The AWS Observability Accelerator for CDK is a set of opinionated modules to help you set up observability for your AWS environments with AWS Native services and AWS-managed observability services such as Amazon Managed Service for Prometheus,Amazon Managed Grafana, AWS Distro for OpenTelemetry (ADOT) and Amazon CloudWatch.</p> <p>We provide curated metrics, logs, traces collection, cloudwatch dashboard, alerting rules and Grafana dashboards for your EKS infrastructure, Java/JMX, NGINX based workloads and your custom applications.</p>"},{"location":"#single-eks-cluster-aws-native-observability-accelerator","title":"Single EKS Cluster AWS Native Observability Accelerator","text":""},{"location":"#singe-eks-cluster-open-source-observability-accelerator","title":"Singe EKS Cluster Open Source Observability Accelerator","text":""},{"location":"#patterns","title":"Patterns","text":"<p>The individual patterns can be found in the <code>lib</code> directory.  Most of the patterns are self-explanatory, for some more complex examples please use this guide and docs/patterns directory for more information.</p>"},{"location":"#documentation","title":"Documentation","text":"<p>Please refer to the AWS CDK Observability Accelertor documentation site for complete project documentation.</p>"},{"location":"#usage","title":"Usage","text":"<p>Before proceeding, make sure AWS CLI is installed on your machine.</p> <p>To use the eks-blueprints and patterns module, you must have Node.js and npm installed. You will also use <code>make</code> to simplify build and other common actions. </p>"},{"location":"#mac-setup","title":"Mac Setup:","text":"<p>Follow the below steps to setup and leverage <code>cdk-aws-observability-accelerator</code> in your local Mac laptop.</p> <ol> <li>Install <code>make</code> and <code>node</code> using brew</li> </ol> <pre><code>brew install make\nbrew install node\n</code></pre> <ol> <li>Install <code>npm</code></li> </ol> <pre><code>sudo npm install -g n\nsudo n stable\n</code></pre> <ol> <li> <p>Make sure the following pre-requisites are met:</p> </li> <li> <p>Node version is a current stable node version 18.x.</p> </li> </ol> <pre><code>$ node -v\nv18.12.1\n</code></pre> <p>Update (provided Node version manager is installed): <code>n stable</code>. May require <code>sudo</code>.</p> <ul> <li>NPM version must be 8.4 or above:</li> </ul> <pre><code>$ npm -v\n8.19.2\n</code></pre> <p>Updating npm: <code>sudo n stable</code> where stable can also be a specific version above 8.4. May require <code>sudo</code>.</p> <ol> <li>Clone the <code>cdk-aws-observability-accelerator</code> repository</li> </ol> <pre><code>git clone https://github.com/aws-observability/cdk-aws-observability-accelerator.git\n</code></pre> <p>PS: If you are contributing to this repo, please make sure to fork the repo, add your changes and create a PR against it.</p> <ol> <li> <p>Once you have cloned the repo, you can open it using your favourite IDE and run the below commands to install the dependencies and build the existing patterns.</p> </li> <li> <p>Install project dependencies.</p> </li> </ol> <pre><code>make deps\n</code></pre> <ul> <li>To view patterns that are available to be deployed, execute the following:</li> </ul> <pre><code>npm i\nmake build\n</code></pre> <ul> <li>To list the existing CDK AWS OBSERVABILITY ACCELERATOR PATTERNS</li> </ul> <pre><code>make list\n</code></pre> <p>Note: Some patterns have a hard dependency on AWS Secrets (for example GitHub access tokens). Initially you will see errors complaining about lack of the required secrets. It is normal. At the bottom, it will show the list of patterns which can be deployed, in case the pattern you are looking for is not available, it is due to the hard dependency which can be fixed by following the docs specific to those patterns.</p> <pre><code>To work with patterns use: \n        $ make pattern &lt;pattern-name&gt; &lt;list | deploy | synth | destroy&gt;\nExample:\n        $ make pattern single-new-eks-cluster-opensource deploy\n\nPatterns:\n\n    single-new-eks-awsnative-observability\n    single-new-eks-mixed-observability\n    single-new-eks-opensource-observability\n</code></pre> <ul> <li>Bootstrap your CDK environment.</li> </ul> <pre><code>npx cdk bootstrap\n</code></pre> <ul> <li>You can then deploy a specific pattern with the following:</li> </ul> <pre><code>make pattern multi-team deploy\n</code></pre>"},{"location":"#developer-flow","title":"Developer Flow","text":""},{"location":"#modifications","title":"Modifications","text":"<p>All files are compiled to the dist folder including <code>lib</code> and <code>bin</code> directories. For iterative development (e.g. if you make a change to any of the patterns) make sure to run compile:</p> <pre><code>make compile\n</code></pre> <p>The <code>compile</code> command is optimized to build only modified files and is fast. </p>"},{"location":"#new-patterns","title":"New Patterns","text":"<p>To create a new pattern, please follow these steps:</p> <ol> <li>Under lib create a folder for your pattern, such as <code>&lt;pattern-name&gt;-construct</code>. If you plan to create a set of patterns that represent a particular subdomain, e.g. <code>security</code> or <code>hardening</code>, please create an issue to discuss it first. If approved, you will be able to create a folder with your subdomain name and group your pattern constructs under it. </li> <li>Blueprints generally don't require a specific class, however we use a convention of wrapping each pattern in a plain class like <code>&lt;Pattern-Name&gt;Construct</code>. This class is generally placed in <code>index.ts</code> under your pattern folder. </li> <li>Once the pattern implementation is ready, you need to include it in the list of the patterns by creating a file <code>bin/&lt;pattern-name&gt;.ts</code>. The implementation of this file is very light, and it is done to allow patterns to run independently.</li> </ol> <p>Example simple synchronous pattern: <pre><code>import { configureApp } from '../lib/common/construct-utils';\nimport FargateConstruct from '../lib/fargate-construct';\n\nnew FargateConstruct(configureApp(), 'fargate'); // configureApp() will create app and configure loggers and perform other prep steps\n</code></pre></p> <ol> <li>In some cases, patterns need to use async APIs. For example, they may rely on external secrets that you want to validate ahead of the pattern deployment. </li> </ol> <p>Example async pattern:</p> <pre><code>import { configureApp, errorHandler } from '../lib/common/construct-utils';\n\nconst app = configureApp();\n\nnew NginxIngressConstruct().buildAsync(app, 'nginx').catch((e) =&gt; {\nerrorHandler(app, \"NGINX Ingress pattern is not setup. This maybe due to missing secrets for ArgoCD admin pwd.\", e);\n});\n</code></pre> <ol> <li>There are a few utility functions that can be used in the pattern implementation such as secret prevalidation. This function will fail if the corresponding secret is not defined, this preventing the pattern to deploy. </li> </ol> <pre><code>await prevalidateSecrets(NginxIngressConstruct.name, undefined, SECRET_ARGO_ADMIN_PWD); await prevalidateSecrets(\"my-pattern-name\", 'us-east-1', 'my-secret-name'); // \n</code></pre>"},{"location":"#security","title":"Security","text":"<p>See CONTRIBUTING for more information.</p>"},{"location":"#license","title":"License","text":"<p>This library is licensed under the MIT-0 License. See the LICENSE file.</p>"},{"location":"contributors/","title":"Contributors","text":"<p>The content on this site is maintained by the Solutions Architects from the AWS observability team with support from the AWS service teams and other volunteers from across the organization.</p> <p>Our goal is to make it easier to use AWS Native and Open Source Observability Services.</p> <p>The core team include the following people:</p> <ul> <li>Elamaran Shanmugam</li> <li>Imaya Kumar Jagannathan</li> <li>Kevin Lewin</li> <li>Michael Hausenblas</li> <li>Mikhail Shapirov</li> <li>Rodrigue Koffi</li> </ul> <p>We welcome the wider open source community and thank those who contribute to this project.</p> <p>Note that all information published on this site is available via the Apache 2.0 license.</p>"},{"location":"support/","title":"Support &amp; Feedback","text":"<p>AWS Observability Accelerator for CDK is maintained by AWS Solution Architects. It is not part of an AWS service and support is provided best-effort by the AWS Observability Accelerator community.</p> <p>To post feedback, submit feature ideas, or report bugs, please use the issues section of this GitHub repo.</p> <p>If you are interested in contributing, see the contribution guide.</p>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-native-observability/","title":"Single New EKS Cluster AWS Native Observability Accelerator","text":""},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-native-observability/#architecture","title":"Architecture","text":"<p>The following figure illustrates the architecture of the pattern we will be deploying for Single EKS Cluster Native Observability pattern using AWS native tools such as CloudWatch Logs and Container Insights.</p> <p></p> <p>This example makes use of CloudWatch Container Insights as a vizualization and metric-aggregation layer. Amazon CloudWatch Container Insights helps customers collect, aggregate, and summarize metrics and logs from containerized applications and microservices. Metrics data is collected as performance log events using the embedded metric format. These performance log events use a structured JSON schema that enables high-cardinality data to be ingested and stored at scale. From this data, CloudWatch creates aggregated metrics at the cluster, node, pod, task, and service level as CloudWatch metrics. The metrics that Container Insights collects are available in CloudWatch automatic dashboards.</p> <p>By combining Container Insights and CloudWatch logs, we are able to provide a foundation for EKS (Elastic Kubernetes Service) Observability. Monitoring EKS for metrics has two categories: the control plane and the Amazon EKS nodes (with Kubernetes objects). The Amazon EKS control plane consists of control plane nodes that run the Kubernetes software, such as etcd and the Kubernetes API server. To read more on the components of an Amazon EKS cluster, please read the service documentation.</p>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-native-observability/#objective","title":"Objective","text":"<ul> <li>Deploys one production grade Amazon EKS cluster.</li> <li>AWS Distro For OpenTelemetry Operator and Collector</li> <li>Logs with AWS for FluentBit and CloudWatch Logs</li> <li>Enables CloudWatch Container Insights.</li> <li>Installs Prometheus Node Exporter for infrastructure metrics.</li> </ul>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-native-observability/#prerequisites","title":"Prerequisites:","text":"<p>Ensure that you have installed the following tools on your machine.</p> <ol> <li>aws cli</li> <li>kubectl</li> <li>cdk</li> <li>npm</li> </ol>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-native-observability/#deploying","title":"Deploying","text":"<ol> <li>Clone your forked repository</li> </ol> <pre><code>git clone https://github.com/aws-observability/cdk-aws-observability-accelerator.git\n</code></pre> <ol> <li>Install the AWS CDK Toolkit globally on your machine using</li> </ol> <pre><code>npm install -g aws-cdk\n</code></pre> <ol> <li> <p>Install project dependencies by running <code>npm install</code> in the main folder of this cloned repository</p> </li> <li> <p>Once all pre-requisites are set you are ready to deploy the pipeline. Run the following command from the root of this repository to deploy the pipeline stack:</p> </li> </ol> <pre><code>make build\nmake pattern single-new-eks-native-observability deploy\n</code></pre>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-native-observability/#verify-the-resources","title":"Verify the resources","text":"<p>Run update-kubeconfig command. You should be able to get the command from CDK output message.</p> <pre><code>aws eks update-kubeconfig --name single-new-eks-native-observability-accelerator --region &lt;your region&gt; --role-arn arn:aws:iam::xxxxxxxxx:role/single-new-eks-opensource-singleneweksopensourceob-82N8N3BMJYYI\n</code></pre> <p>Let\u2019s verify the resources created by steps above.</p> <p><pre><code>kubectl get nodes -o wide\n</code></pre> Output:</p> <pre><code>NAME                                         STATUS   ROLES    AGE    VERSION               INTERNAL-IP    EXTERNAL-IP   OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME\nip-10-0-104-200.us-west-2.compute.internal   Ready    &lt;none&gt;   2d1h   v1.25.9-eks-0a21954   10.0.104.200   &lt;none&gt;        Amazon Linux 2   5.10.179-168.710.amzn2.x86_64   containerd://1.6.19\n</code></pre> <p>Next, lets verify the namespaces in the cluster:</p> <pre><code>kubectl get ns # Output shows all namespace\n</code></pre> <p>Output:</p> <pre><code>NAME                       STATUS   AGE\namazon-metrics             Active   10m\naws-for-fluent-bit         Active   10m\ncert-manager               Active   10m\ndefault                    Active   16m\nkube-node-lease            Active   16m\nkube-public                Active   16m\nkube-system                Active   16m\nprometheus-node-exporter   Active   10m\n</code></pre>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-native-observability/#visualization","title":"Visualization","text":"<p>Navigate to CloudWatch and go to \"Container Insights\".</p> <p>View the Container Map:</p> <p></p> <p>View the Resource List:</p> <p></p> <p>View the Performance Monitoring Dashboard:</p> <p></p>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-native-observability/#viewing-logs","title":"Viewing Logs","text":"<p>By default, we deploy a FluentBit daemon set in the cluster to collect worker logs for all namespaces. Logs are collected and exported to Amazon CloudWatch Logs, which enables you to centralize the logs from all of your systems, applications, and AWS services that you use, in a single, highly scalable service.</p>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-native-observability/#using-cloudwatch-logs-insights-to-query-logs","title":"Using CloudWatch Logs Insights to Query Logs","text":"<p>Navigate to CloudWatch, then go to \"Logs Insights\"</p> <p>In the dropdown, select any of the logs that begin with \"/aws/eks/single-new-eks-awsnative-observability-accelerator\" and run a query.</p> <p>Example with \"kubesystem\" log group:</p> <p></p> <p>Then you can view the results of your query:</p> <p></p>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-native-observability/#teardown","title":"Teardown","text":"<p>You can teardown the whole CDK stack with the following command:</p> <pre><code>make pattern single-new-eks-native-observability destroy\n</code></pre>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/","title":"Singe New EKS Cluster Open Source Observability Accelerator","text":""},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#architecture","title":"Architecture","text":"<p>The following figure illustrates the architecture of the pattern we will be deploying for Single EKS Cluster Open Source Observability pattern using open source tooling such as AWS Distro for Open Telemetry (ADOT), Amazon Managed Service for Prometheus (AMP), Amazon Managed Grafana :</p> <p></p> <p>Monitoring Amazon Elastic Kubernetes Service (Amazon EKS) for metrics has two categories: the control plane and the Amazon EKS nodes (with Kubernetes objects). The Amazon EKS control plane consists of control plane nodes that run the Kubernetes software, such as etcd and the Kubernetes API server. To read more on the components of an Amazon EKS cluster, please read the service documentation.</p>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#objective","title":"Objective","text":"<ul> <li>Deploys one production grade Amazon EKS cluster.</li> <li>AWS Distro For OpenTelemetry Operator and Collector for Metrics and Traces</li> <li>Logs with AWS for FluentBit</li> <li>Installs Grafana Operator to add AWS data sources and create Grafana Dashboards to Amazon Managed Grafana.</li> <li>Installs FluxCD to perform GitOps sync of a Git Repo to EKS Cluster. We will use this later for creating Grafana Dashboards and AWS datasources to Amazon Managed Grafana. You can also use your own GitRepo  to sync your own Grafana resources such as Dashboards, Datasources etc. Please check our One observability module - GitOps with Amazon Managed Grafana to learn more about this.</li> <li>Installs External Secrets Operator to retrieve and Sync the Grafana API keys.</li> <li>Amazon Managed Grafana Dashboard and data source</li> <li>Alerts and recording rules with AWS Managed Service for Prometheus</li> </ul>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#prerequisites","title":"Prerequisites:","text":"<p>Ensure that you have installed the following tools on your machine.</p> <ol> <li>aws cli</li> <li>kubectl</li> <li>cdk</li> <li>npm</li> </ol>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#deploying","title":"Deploying","text":"<ol> <li>Clone your forked repository</li> </ol> <pre><code>git clone https://github.com/aws-observability/cdk-aws-observability-accelerator.git\n</code></pre> <ol> <li>Install the AWS CDK Toolkit globally on your machine using</li> </ol> <pre><code>npm install -g aws-cdk\n</code></pre> <ol> <li>Amazon Managed Grafana workspace: To visualize metrics collected, you need an Amazon Managed Grafana workspace. If you have an existing workspace, create an environment variable as described below. To create a new workspace, visit our supporting example for Grafana</li> </ol> <p>Note</p> <p>For the URL <code>https://g-xyz.grafana-workspace.us-east-1.amazonaws.com</code>, the workspace ID would be <code>g-xyz</code></p> <pre><code>export AWS_REGION=&lt;YOUR AWS REGION&gt;\nexport COA_AMG_WORKSPACE_ID=g-xxx\nexport COA_AMG_ENDPOINT_URL=https://g-xyz.grafana-workspace.us-east-1.amazonaws.com\n</code></pre> <p>Warning</p> <p>Setting up environment variables <code>COA_AMG_ENDPOINT_URL</code> and <code>AWS_REGION</code> is mandatory for successful execution of this pattern.</p> <ol> <li>GRAFANA API KEY: Amazon Managed Grafana provides a control plane API for generating Grafana API keys.</li> </ol> <pre><code>export AMG_API_KEY=$(aws grafana create-workspace-api-key \\\n--key-name \"grafana-operator-key\" \\\n--key-role \"ADMIN\" \\\n--seconds-to-live 432000 \\\n--workspace-id $COA_AMG_WORKSPACE_ID \\\n--query key \\\n--output text)\n</code></pre> <ol> <li>AWS Secrets Manager for GRAFANA API KEY: Update the Grafana API key secret in AWS Secrets using the above new Grafana API key. This will be referenced by Grafana Operator deployment of our solution to access Amazon Managed Grafana from Amazon EKS Cluster</li> </ol> <pre><code>export API_KEY_SECRET_NAME=\"grafana-api-key\"\naws secretsmanager update-secret \\\n--secret-id $API_KEY_SECRET_NAME \\\n--secret-string \"${AMG_API_KEY}\" \\\n--region $AWS_REGION\n</code></pre> <ol> <li> <p>Install project dependencies by running <code>npm install</code> in the main folder of this cloned repository. </p> </li> <li> <p>The actual settings for dashboard urls are expected to be specified in the CDK context. Generically it is inside the cdk.json file of the current directory or in <code>~/.cdk.json</code> in your home directory. </p> </li> </ol> <p>Example settings: Update the context in <code>cdk.json</code> file located in <code>cdk-eks-blueprints-patterns</code> directory</p> <pre><code>    \"context\": {\n        \"cluster.dashboard.url\": \"https://raw.githubusercontent.com/aws-observability/aws-observability-accelerator/main/artifacts/grafana-dashboards/eks/infrastructure/cluster.json\",\n        \"kubelet.dashboard.url\": \"https://raw.githubusercontent.com/aws-observability/aws-observability-accelerator/main/artifacts/grafana-dashboards/eks/infrastructure/kubelet.json\",\n        \"namespaceworkloads.dashboard.url\": \"https://raw.githubusercontent.com/aws-observability/aws-observability-accelerator/main/artifacts/grafana-dashboards/eks/infrastructure/namespace-workloads.json\",\n        \"nodexporter.dashboard.url\": \"https://raw.githubusercontent.com/aws-observability/aws-observability-accelerator/main/artifacts/grafana-dashboards/eks/infrastructure/nodeexporter-nodes.json\",\n        \"nodes.dashboard.url\": \"https://raw.githubusercontent.com/aws-observability/aws-observability-accelerator/main/artifacts/grafana-dashboards/eks/infrastructure/nodes.json\",\n        \"workloads.dashboard.url\": \"https://raw.githubusercontent.com/aws-observability/aws-observability-accelerator/main/artifacts/grafana-dashboards/eks/infrastructure/workloads.json\"\n      }\n</code></pre> <ol> <li>Once all pre-requisites are set you are ready to deploy the pipeline. Run the following command from the root of this repository to deploy the pipeline stack:</li> </ol> <pre><code>make build\nmake pattern single-new-eks-opensource-observability deploy\n</code></pre>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#verify-the-resources","title":"Verify the resources","text":"<p>Run update-kubeconfig command. You should be able to get the command from CDK output message.</p> <pre><code>aws eks update-kubeconfig --name single-new-eks-opensource-observability-accelerator --region &lt;your region&gt; --role-arn arn:aws:iam::xxxxxxxxx:role/single-new-eks-opensource-singleneweksopensourceob-82N8N3BMJYYI\n</code></pre> <p>Let\u2019s verify the resources created by steps above.</p> <p><pre><code>kubectl get nodes -o wide\n</code></pre> Output:</p> <pre><code>NAME                                         STATUS   ROLES    AGE    VERSION               INTERNAL-IP    EXTERNAL-IP   OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME\nip-10-0-104-200.us-west-2.compute.internal   Ready    &lt;none&gt;   2d1h   v1.25.9-eks-0a21954   10.0.104.200   &lt;none&gt;        Amazon Linux 2   5.10.179-168.710.amzn2.x86_64   containerd://1.6.19\n</code></pre> <p>Next, lets verify the namespaces in the cluster:</p> <pre><code>kubectl get ns # Output shows all namespace\n</code></pre> <p>Output:</p> <pre><code>NAME                            STATUS   AGE\ncert-manager                    Active   2d1h\ndefault                         Active   2d1h\nexternal-secrets                Active   2d1h\nflux-system                     Active   2d1h\ngrafana-operator                Active   2d1h\nkube-node-lease                 Active   2d1h\nkube-public                     Active   2d1h\nkube-system                     Active   2d1h\nopentelemetry-operator-system   Active   2d1h\nprometheus-node-exporter        Active   2d1h\n</code></pre> <p>Next, lets verify all resources of <code>grafana-operator</code> namespace:</p> <pre><code>kubectl get all --namespace=grafana-operator\n</code></pre> <p>Output:</p> <pre><code>NAME                                    READY   STATUS    RESTARTS   AGE\npod/grafana-operator-866d4446bb-g5srl   1/1     Running   0          2d1h\n\nNAME                                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\nservice/grafana-operator-metrics-service   ClusterIP   172.20.223.125   &lt;none&gt;        9090/TCP   2d1h\n\nNAME                               READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/grafana-operator   1/1     1            1           2d1h\n\nNAME                                          DESIRED   CURRENT   READY   AGE\nreplicaset.apps/grafana-operator-866d4446bb   1         1         1       2d1h\n</code></pre>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#visualization","title":"Visualization","text":""},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#1-grafana-dashboards","title":"1. Grafana dashboards","text":"<p>Login to your Grafana workspace and navigate to the Dashboards panel. You should see a list of dashboards under the <code>Observability Accelerator Dashboards</code></p> <p></p> <p>Open the <code>Node Exporter</code> dashboard and you should be able to view its visualization as shown below :</p> <p></p> <p>Open the <code>Kubelet</code> dashboard and you should be able to view its visualization as shown below :</p> <p></p> <p>From the cluster to view all dashboards as Kubernetes objects, run:</p> <pre><code>kubectl get grafanadashboards -A\n</code></pre> <pre><code>NAMESPACE          NAME                                   AGE\ngrafana-operator   cluster-grafanadashboard               138m\ngrafana-operator   java-grafanadashboard                  143m\ngrafana-operator   kubelet-grafanadashboard               13h\ngrafana-operator   namespace-workloads-grafanadashboard   13h\ngrafana-operator   nginx-grafanadashboard                 134m\ngrafana-operator   node-exporter-grafanadashboard         13h\ngrafana-operator   nodes-grafanadashboard                 13h\ngrafana-operator   workloads-grafanadashboard             13h\n</code></pre> <p>You can inspect more details per dashboard using this command</p> <pre><code>kubectl describe grafanadashboards cluster-grafanadashboard -n grafana-operator\n</code></pre> <p>Grafana Operator and Flux always work together to synchronize your dashboards with Git. If you delete your dashboards by accident, they will be re-provisioned automatically.</p>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#viewing-logs","title":"Viewing Logs","text":"<p>By default, we deploy a FluentBit daemon set in the cluster to collect worker logs for all namespaces. Logs are collected and exported to Amazon CloudWatch Logs, which enables you to centralize the logs from all of your systems, applications, and AWS services that you use, in a single, highly scalable service.</p>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#using-cloudwatch-logs-as-data-source-in-grafana","title":"Using CloudWatch Logs as data source in Grafana","text":"<p>Follow the documentation to enable Amazon CloudWatch as a data source. Make sure to provide permissions.</p> <p>All logs are delivered in the following CloudWatch Log groups naming pattern: <code>/aws/eks/single-new-eks-opensource-observability-accelerator</code>. Log streams follow <code>{container-name}.{pod-name}</code>. In Grafana, querying and analyzing logs is done with CloudWatch Logs Insights</p>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#example-adot-collector-logs","title":"Example - ADOT collector logs","text":"<p>Select one or many log groups and run the following query. The example below, queries AWS Distro for OpenTelemetry (ADOT) logs</p> <pre><code>fields @timestamp, log\n| order @timestamp desc\n| limit 100\n</code></pre> <p></p>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#example-using-time-series-visualizations","title":"Example - Using time series visualizations","text":"<p>CloudWatch Logs syntax provide powerful functions to extract data from your logs. The <code>stats()</code> function allows you to calculate aggregate statistics with log field values. This is useful to have visualization on non-metric data from your applications.</p> <p>In the example below, we use the following query to graph the number of metrics collected by the ADOT collector</p> <pre><code>fields @timestamp, log\n| parse log /\"#metrics\": (?&lt;metrics_count&gt;\\d+)}/\n| stats avg(metrics_count) by bin(5m)\n| limit 100\n</code></pre> <p>Tip</p> <p>You can add logs in your dashboards with logs panel types or time series depending on your query results type.</p> <p></p> <p>Warning</p> <p>Querying CloudWatch logs will incur costs per GB scanned. Use small time windows and limits in your queries. Checkout the CloudWatch pricing page for more infos.</p>"},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#troubleshooting","title":"Troubleshooting","text":""},{"location":"patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability/#1-grafana-dashboards-missing-or-grafana-api-key-expired","title":"1. Grafana dashboards missing or Grafana API key expired","text":"<p>In case you don't see the grafana dashboards in your Amazon Managed Grafana console, check on the logs on your grafana operator pod using the below command :</p> <pre><code>kubectl get pods -n grafana-operator\n</code></pre> <p>Output:</p> <pre><code>NAME                                READY   STATUS    RESTARTS   AGE\ngrafana-operator-866d4446bb-nqq5c   1/1     Running   0          3h17m\n</code></pre> <pre><code>kubectl logs grafana-operator-866d4446bb-nqq5c -n grafana-operator\n</code></pre> <p>Output:</p> <pre><code>1.6857285045556655e+09  ERROR   error reconciling datasource    {\"controller\": \"grafanadatasource\", \"controllerGroup\": \"grafana.integreatly.org\", \"controllerKind\": \"GrafanaDatasource\", \"GrafanaDatasource\": {\"name\":\"grafanadatasource-sample-amp\",\"namespace\":\"grafana-operator\"}, \"namespace\": \"grafana-operator\", \"name\": \"grafanadatasource-sample-amp\", \"reconcileID\": \"72cfd60c-a255-44a1-bfbd-88b0cbc4f90c\", \"datasource\": \"grafanadatasource-sample-amp\", \"grafana\": \"external-grafana\", \"error\": \"status: 401, body: {\\\"message\\\":\\\"Expired API key\\\"}\\n\"}\ngithub.com/grafana-operator/grafana-operator/controllers.(*GrafanaDatasourceReconciler).Reconcile\n</code></pre> <p>If you observe, the the above <code>grafana-api-key error</code> in the logs, your grafana API key is expired. Please use the operational procedure to update your <code>grafana-api-key</code> :</p> <ul> <li>First, lets create a new Grafana API key.</li> </ul> <pre><code>export GO_AMG_API_KEY=$(aws grafana create-workspace-api-key \\\n--key-name \"grafana-operator-key-new\" \\\n--key-role \"ADMIN\" \\\n--seconds-to-live 432000 \\\n--workspace-id $COA_AMG_WORKSPACE_ID \\\n--query key \\\n--output text)\n</code></pre> <ul> <li>Finally, update the Grafana API key secret in AWS Secrets Manager using the above new Grafana API key:</li> </ul> <pre><code>export API_KEY_SECRET_NAME=\"grafana-api-key\"\naws secretsmanager update-secret \\\n--secret-id $API_KEY_SECRET_NAME \\\n--secret-string \"${AMG_API_KEY}\" \\\n--region $AWS_REGION\n</code></pre> <ul> <li>If the issue persists, you can force the synchronization by deleting the <code>externalsecret</code> Kubernetes object.</li> </ul> <pre><code>kubectl delete externalsecret/external-secrets-sm -n grafana-operator\n</code></pre>"}]}